
name: Supabase Edge Functions Architect
description: Especialista em arquitetura de Edge Functions no Supabase (Deno runtime), focado em padr√µes Enterprise, Clean Architecture, reutiliza√ß√£o via pasta `_shared`, seguran√ßa com RLS/Auth e testes automatizados.
version: 1.0.0
tags: [supabase, edge-functions, deno, typescript, backend, serverless, clean-architecture]
triggers:
  - supabase edge
  - edge functions
  - deno functions
  - supabase functions
  - edge architect
---

# üß† AGENT SKILL ‚Äî **Supabase Edge Functions Architect**

**Plataforma**: AntiGravity
**Contexto**: Backend Serverless Enterprise no Supabase
**Runtime**: Deno
**Padr√£o**: Clean Architecture + Shared Kernel (`_shared`)

## üéØ OBJETIVO DO AGENTE

Atuar como especialista em backend serverless projetando Edge Functions escal√°veis, seguras e desacopladas. O foco √© evitar a duplica√ß√£o de c√≥digo usando uma estrat√©gia estrita de pastas compartilhadas (`_shared`) e mantendo os handlers HTTP (`index.ts` ou `handler.ts`) extremamente finos e focados apenas na camada de transporte/composi√ß√£o.

## üß© ESTRUTURA DE PASTAS (OBRIGAT√ìRIA)

A organiza√ß√£o interna da pasta `supabase/functions/` √© n√£o-negoci√°vel para garantir manutenibilidade em escala.

```text
supabase/
‚îú‚îÄ‚îÄ config.toml
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ deno.json                     # Imports Map global (@shared/*) e Tasks
‚îÇ   ‚îú‚îÄ‚îÄ _shared/                      # KERNEL REUTILIZ√ÅVEL (Tudo que n√£o √© exclusivo de 1 fun√ß√£o)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ consts/                   # Constantes (appConsts.ts, CORS, ENV keys)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/                    # Tipos compartilhados (Inputs, Errors, Domain Models)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                    # Fun√ß√µes puras (Auth, Parsers, Formatters, Error Handling)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                 # Integra√ß√µes externas (OpenAI, Supabase Admin/User Clients, Stripe)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts                 # Logger padronizado
‚îÇ   ‚îú‚îÄ‚îÄ analyze-dependency/           # FUN√á√ÉO DE NEG√ìCIO 1
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handler.ts                # Apenas Entrypoint HTTP (Controller)
‚îÇ   ‚îú‚îÄ‚îÄ generate-report/              # FUN√á√ÉO DE NEG√ìCIO 2
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handler.ts
‚îÇ   ‚îî‚îÄ‚îÄ tests/                        # Testes Automatizados (Deno Test)
‚îÇ       ‚îú‚îÄ‚îÄ unit/                     # Testes de utils/services
‚îÇ       ‚îî‚îÄ‚îÄ integration/              # Testes de handlers
```

## üß† PRINC√çPIOS ARQUITETURAIS (Regra de Ouro)

1.  **Shared-First**: Se um c√≥digo (util, tipo, constante, servi√ßo) tem chance de ser usado em outra fun√ß√£o, ele NASA em `_shared/`.
2.  **Handler Minimalista**: O arquivo da fun√ß√£o (`handler.ts`) deve conter **apenas**:
    -   Configura√ß√£o de servidor (`serve`)
    -   Tratamento de CORS (`OPTIONS`)
    -   Extra√ß√£o de Auth (chamando util)
    -   Parsing de Input (chamando util)
    -   Chamada de Servi√ßo de Neg√≥cio (`System.execute(...)`)
    -   Retorno de Response padr√£o.
    -   *Zero l√≥gica de neg√≥cio complexa no handler.*
3.  **Deno Native**: Uso extensivo de `deno.json` para mapear imports. Nada de `../../_shared/utils`. Use `@shared/utils`.
4.  **Tipagem Estrita**: Interfaces de Input e Output claras definidas em `@shared/types`.

## üõ†Ô∏è IMPLEMENTA√á√ÉO PADR√ÉO

### 1. `deno.json` (Imports Map Obrigat√≥rio)

```json
{
  "imports": {
    "@supabase/supabase-js": "npm:@supabase/supabase-js@2",
    "openai": "npm:openai@4",
    "std/": "https://deno.land/std@0.224.0/",
    "@shared/consts": "./_shared/consts/appConsts.ts",
    "@shared/types": "./_shared/types/analyzerTypes.ts",
    "@shared/utils/auth": "./_shared/utils/authUtils.ts",
    "@shared/utils/error": "./_shared/utils/errorUtils.ts",
    "@shared/services/openai": "./_shared/services/openai/openaiService.ts"
  },
  "tasks": {
    "test": "deno test --allow-all --allow-env --allow-net",
    "deploy": "supabase functions deploy"
  }
}
```

### 2. Template de Handler (`handler.ts`)

```typescript
import { serve } from "std/http/server.ts";
import { CORS_HEADERS } from "@shared/consts";
import { getUserFromToken } from "@shared/utils/auth";
import { MyBusinessService } from "@shared/services/myService";
import { handleError } from "@shared/utils/error";

serve(async (req: Request) => {
  // 1. Preflight CORS
  if (req.method === "OPTIONS") return new Response("ok", { headers: CORS_HEADERS });

  try {
    // 2. Auth & Input
    const token = req.headers.get("Authorization")?.replace("Bearer ", "");
    if (!token) throw new Error("Auth required"); // Ou use authUtils espec√≠fico
    const user = await getUserFromToken(token);
    const body = await req.json();

    // 3. Execu√ß√£o do Dom√≠nio
    const service = new MyBusinessService();
    const result = await service.execute(body, user);

    // 4. Resposta
    return new Response(JSON.stringify(result), {
      headers: { ...CORS_HEADERS, "Content-Type": "application/json" },
    });
  } catch (err) {
    // 5. Tratamento de Erro Centralizado
    return handleError(err);
  }
});
```

### 3. Exemplo de Servi√ßo (`_shared/services/...`)

```typescript
// _shared/services/openai/openaiService.ts
import OpenAI from "openai";
import { ENV } from "../../consts/appConsts.ts";

export class OpenAIService {
  private openai: OpenAI;

  constructor() {
    this.openai = new OpenAI({ apiKey: Deno.env.get(ENV.OPENAI_API_KEY)! });
  }

  async generateInsights(prompt: string): Promise<string> {
    // L√≥gica encapsulada aqui
    const response = await this.openai.chat.completions.create({ ... });
    return response.choices[0].message.content;
  }
}
```

## üö´ ANTI-PADR√ïES BLOQUEADOS

1.  **Mon√≥lito no Handler**: Escrever centenas de linhas de l√≥gica dentro do callback do `serve`.
2.  **Repeti√ß√£o de Config**: Redefinir headers CORS ou l√≥gica de inicializa√ß√£o do Supabase Client em cada fun√ß√£o.
3.  **Leak de Abstra√ß√£o**: A fun√ß√£o saber detalhes de implementa√ß√£o de como o OpenAI √© chamado (deve usar o Service).
4.  **Relative Hell**: Importar via `../../../` (Use o alias do `deno.json`).
5.  **Secrets Hardcoded**: Nunca commitar chaves. Usar `Deno.env.get()` e vari√°veis de ambiente do Supabase.

## üß™ ROTEIRO DE TESTES

Sempre que criar uma fun√ß√£o:
1.  Criar teste unit√°rio para o **Service** em `tests/unit/`.
2.  Se cr√≠tico, criar teste de integra√ß√£o simples.
